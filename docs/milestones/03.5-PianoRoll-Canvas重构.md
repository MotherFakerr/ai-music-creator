# 里程碑 3.5: PianoRoll Canvas 重构

## 目标

将 PianoRoll 从纯 DOM 渲染改为 Canvas + DOM 混合渲染，解决大量音符时的性能问题，同时保持现有交互体验。

## 渲染分层

| 层级 | 渲染方式 | 说明 |
|-----|---------|------|
| Pitch Label | DOM | 最左边显示音阶名，固定不随横向 scroll 移动 |
| 网格线 | Canvas | 横向格子 |
| 音符 | Canvas | 可选/拖拽/缩放 |
| 播放头 | Canvas | 实时移动 |
| 框选框 | Canvas | 选区高亮 |
| Bar Guide | Canvas | 小节分隔线 |
| Scrollbar | 原生 | 保持不变 |

## 交互保持

- ✅ 点击格子添加音符
- ✅ 框选（拖拽空白区域）
- ✅ 拖拽移动音符
- ✅ 拖拽右边缘缩放音符
- ✅ 右键删除音符
- ✅ Ctrl/Cmd + 点击多选
- ✅ 播放头自动滚动
- ✅ 滚轮 scroll（水平和垂直）

## 技术方案

### 1. 容器结构

```
┌────────────┬────────────────────────────┐
│ Pitch Label│      Canvas (绘图层)       │ ← 随 scroll 移动
│   (DOM)    │                            │
│   (固定)   │                            │
└────────────┴────────────────────────────┘
```

### 2. Canvas 尺寸计算

- `canvas.width = totalSteps * stepWidth`
- `canvas.height = pitchRows.length * rowHeight`
- 通过 CSS `transform: translate()` 或 `scrollLeft/scrollTop` 实现移动

### 3. 事件处理

- 鼠标事件监听在 DOM 容器上
- 计算坐标：`step = (clientX - rect.left) / stepWidth`
- 通过 `requestAnimationFrame` 进行重绘

### 4. 图层分离

为简化渲染，可以分两层 Canvas：
- **背景层**: 网格线、bar guide（变化少）
- **音符层**: 音符、播放头、框选框（每帧重绘）

或者单层 Canvas，按需重绘。

## 验收标准

1. 500+ 音符时滚动和拖拽保持 60fps
2. 所有交互行为与原版一致
3. 视觉风格保持不变

## 拆分任务

1. [ ] 创建 Canvas 容器结构
2. [ ] 实现网格线绘制
3. [ ] 实现音符渲染
4. [ ] 迁移播放头
5. [ ] 迁移框选交互
6. [ ] 处理 scroll 同步
7. [ ] 性能测试与优化
