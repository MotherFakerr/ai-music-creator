# 里程碑2.5：编曲工作台（Channel Rack + Piano Roll）

> 状态：开发中（基础能力已实现）

## 目标

提供类似 FL Studio 的基础编曲体验，围绕「通道机架 + 钢琴卷帘」完成可编辑、可试听、可迭代的编曲工作流。

## 范围说明

本里程碑属于 `2.5`，定位为从「演奏/跟奏」到「结构化编曲」的中间层能力，承上启下：

- 承接里程碑 1/2 的实时演奏与音频能力
- 为里程碑 3（MIDI 结构化记录）提供编辑器基础
- 为里程碑 4（AI 共创续写）提供可消费的片段输入

## 当前已完成功能清单

### 1) 架构与集成

- ✅ 在 monorepo 中新增独立 package：`packages/sequencer`
- ✅ 在 `web` 中完成集成，可在主页面挂载 `PatternEditor`
- ✅ 新增独立调试页：`/sequencer-debug`

### 2) Channel Rack（通道机架）

- ✅ 多通道展示（Kick / Snare / Hat）
- ✅ 16-step 开关编辑
- ✅ 通道选中
- ✅ 通道静音（Mute）
- ✅ 通道 Solo
- ✅ 通道音量（Volume）
- ✅ 通道新增/删除（删除时同步清理关联音符）
- ✅ 通道重命名（草稿 + Rename 确认提交）
- ✅ 通道排序（上移/下移）
- ✅ 每通道音色切换（Drum/Piano/Synth/Guitar/Dist Guitar）

### 3) Piano Roll（钢琴卷帘）

- ✅ 网格新增音符（点击空白区）
- ✅ 右键删除音符
- ✅ 拖拽移动音符（时间 + 音高）
- ✅ 拖拽右侧把手调整音符长度
- ✅ 网格吸附（Snap：1/16、1/8、1/4）
- ✅ 新增音符预听、拖动改音高实时预听
- ✅ 全 MIDI 音高范围（0-127）+ 垂直滚动
- ✅ 横向缩放（Zoom）
- ✅ 稳定行高与网格对齐修复（避免视觉偏移与错格）

### 4) 多选与批量编辑

- ✅ 框选多音符
- ✅ Ctrl/Cmd + Click 多选
- ✅ Delete/Backspace 键盘删除选中音符
- ✅ 选中后显示上方参数操作区
- ✅ 批量参数：Velocity、Length、Transpose、Nudge
- ✅ 复制/粘贴（Ctrl/Cmd + C / V）
- ✅ 粘贴后自动选中新内容
- ✅ 粘贴锚点按当前视口位置，不打断后段编辑流

### 5) 播放与循环（调试态）

- ✅ Play / Stop / Reset
- ✅ BPM 调整
- ✅ Loop 开关 + Loop In / Loop Out
- ✅ 播放头显示
- ✅ 播放头自动跟随
- ✅ 回放调度精度提升（时间补偿循环）
- ✅ 与 `@ai-music-creator/audio` 联动发声（按步触发通道与音符）
- ✅ 回放按通道配置生效（Solo/Mute/Volume/Instrument）

### 6) 编辑体验与历史

- ✅ Undo / Redo（按钮 + 快捷键）
- ✅ 拖拽事务化历史（一次拖拽一次撤销，不逐格回退）
- ✅ 滚动条交互不误触发取消选择
- ✅ 网格/框选/音符定位统一像素基准，避免越往后偏移

## 暂不纳入（本里程碑后续再做）

- ❌ 专业级 DAW 完整功能（复杂编排、自动化曲线、混音台）
- ❌ 复杂音频编辑（切片、时间拉伸、频谱处理）
- ❌ 完整 MIDI 工程管理（留待里程碑 3）

## 待选能力（已记录，暂不优先）

- ⏳ Quantize（量化）：
  - 对选中音符按当前 Snap 粒度对齐（例如 1/16、1/8）
  - 支持 100% 完全量化与 50% 半量化（可选）

## 成功标准（当前阶段）

- 在 `/sequencer-debug` 可完成基础编曲闭环：新增 -> 编辑 -> 多选批量调整 -> 循环试听
- 关键交互稳定，无明显行列错位或播放步进错乱
- 能作为里程碑 3/4 的编辑器基础继续扩展
