# 里程碑一：音乐演奏

> 状态：✅ 已完成 | 优先级：P0

## 目标

**让用户用电脑键盘快速弹奏出旋律，< 1 分钟内上手。**

---

## 用户故事

| 编号 | 场景 | 预期行为 |
|-----|------|---------|
| US-01 | 打开页面 | 看到键盘界面 + 立即可弹奏 |
| US-02 | 按下按键 | 听到对应音符（无延迟） |
| US-03 | 按住按键 | 音符持续发声，松开停止 |
| US-04 | 切换音色 | 从当前音色切换到另一种 |
| US-05 | 可视反馈 | 按键时有视觉高亮，显示当前音符 |
| US-06 | 演奏轨迹 | 看到音符轨迹效果 |

---

## 功能范围

### ✅ 已完成

| 功能 | 描述 |
|-----|------|
| 键盘映射 | QWERTY 键盘 → 音符（C2-B5，3 octaves） |
| 实时演奏 | 按键即响，延迟 < 50ms |
| 音色切换 | 4 种：钢琴、合成器、电吉他、鼓组 |
| 演奏可视化 | 按键高亮 + 多音符显示 + 轨迹效果 |
| 基准音调节 | 可自定义基准音（C3-C4） |
| 音量控制 | 可调节主音量 |

### ❌ 不做

- 延音踏板支持
- 力度感应（Web 键盘无法获取）
- 多指和弦识别
- MIDI 输入设备支持

---

## 键盘映射方案

### 映射规则

```
行 3（A 键）= 基准音（默认 C3）
同行右移 = +1 半音
行之间（从上到下）= ±1 八度

行 1（A 上 2 行）= 基准 + 2 八度 (+24)
行 2（A 上 1 行）= 基准 + 1 八度 (+12)
行 3（A 所在行）= 基准音 (默认 C3)
行 4（A 下 1 行）= 基准 - 1 八度 (-12)
```

### 完整映射表（基准 = C3）

```
【行 1】1   2   3   4   5   6   7   8   9   0   -   =
【行 1】C5 C#5 D5 D#5 E5 F5 F#5 G5 G#5 A5 A#5 B5

【行 2】Q   W   E   R   T   Y   U   I   O   P   [   ]
【行 2】C4 C#4 D4 D#4 E4 F4 F#4 G4 G#4 A4 A#4 B4

【行 3】A   S   D   F   G   H   J   K   L   ;   '
【行 3】C3 C#3 D3 D#3 E3 F3 F#3 G3 G#3 A3 A#3 B3

【行 4】Z   X   C   V   B   N   M   ,   .   /
【行 4】C2 C#2 D2 D#2 E2 F2 F#2 G2 G#2 A2
```

> **当前范围**：C2 - B5（3 octaves）
> **可配置**：基准音可自定义（默认 C3）

---

## 音色定义

| 音色 ID | 名称 | 声音来源 |
|--------|------|---------|
| piano | 钢琴 | smplr SoundFont (acoustic_grand_piano) |
| synth | 合成器 | smplr SoundFont (synth_brass_1) |
| guitar | 电吉他 | smplr SoundFont (electric_guitar_clean) |
| drum | 鼓组 | Oscillator 模拟 |

> **音色库**：使用 smplr 加载开源 SoundFont 采样，音色更真实
> **音色切换**：通过 UI 按钮或下拉菜单实现

---

## 交互设计

### 技术实现

```
┌─────────────────────────────────────────────────────┐
│ 🎵 AI Music Creator                              │
│ 状态: ● 已就绪                                   │
├─────────────────────────────────────────────────────┤
│ ┌──────────────────┐ ┌─────────────────────────┐ │
│ │ 基准音: C4       │ │ 音量: ●●●●●○○○○○     │ │
│ ▲ ▼                │ └─────────────────────────┘ │
│ ┌──────────────────┐                             │
│ │ 音色选择          │                             │
│ │ [钢琴] [合成器]  │                             │
│ │ [电吉他] [鼓组]  │                             │
│ └──────────────────┘                             │
├─────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────┐   │
│ │ 演奏预览面板                                │   │
│ │ ┌─────────────────────────────────────┐    │   │
│ │ │                                     │    │   │
│ │ │         音符轨迹效果                  │    │   │
│ │ │                                     │    │   │
│ │ └─────────────────────────────────────┘    │   │
│ │ 当前音符: C4 · D4 · F4                       │
│ └───────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────┐   │
│ │ 虚拟键盘 (QWERTY 布局)                      │   │
│ │ 1 2 3 4 5 6 7 8 9 0 - =                 │   │
│ │ Q W E R T Y U I O P [ ]                   │   │
│ │ A S D F G H J K L ; '                     │   │
│ │ Z X C V B N M , . /                       │   │
│ └───────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

### UI 组件库

- **框架**: React + Vite
- **UI 组件**: Mantine Core
- **样式**: Mantine Theme + CSS Modules

---

## 演奏可视化

### 音符轨迹效果

- **轨迹类型**: 时间衰减的音符粒子
- **颜色映射**: 12 音阶 → 不同色相（暖色谱）
- **强度显示**: 根据力度动态调整透明度
- **最大显示**: 同时显示最多 48 个音符轨迹

### 多音符显示

- 同时按下的音符以 pill 标签形式显示
- 按音符音高自动排序
- 以 "· " 分隔

---

## 成功标准

| 指标 | 目标 | 状态 |
|-----|------|-----|
| 首次上手时间 | < 30 秒 | ✅ |
| 演奏延迟 | < 50ms | ✅ |
| 键盘覆盖范围 | C2 - B5（3 octaves） | ✅ |
| 音色数量 | ≥ 4 种 | ✅ |
| 演奏可视化 | 轨迹 + 多音符显示 | ✅ |

---

## 技术实现细节

### 音频引擎

- **库**: smplr (SoundFont Player)
- **回退**: Oscillator (当 SoundFont 加载失败时)
- **鼓组**: 特殊处理，使用 Oscillator 模拟

### 性能优化

- 乐器按需加载（懒加载）
- 轨迹数组限制（最大 48 项）
- useMemo 优化计算密集型操作

---

## 待改进项（已关闭）

> 里程碑 1 功能已完成，以下问题暂不处理
> - 力度感应（需要 MIDI 输入设备）
> - 延音踏板支持
> - 更多乐器音色
> - 录音回放功能

---

## 总结

### ✅ 成果

| 功能 | 状态 | 说明 |
|-----|------|------|
| 键盘映射 | ✅ | QWERTY → 音符（C2-B5，3 octaves） |
| 实时演奏 | ✅ | 按键即响，延迟 < 50ms |
| 音色切换 | ✅ | 4 种：钢琴、合成器、电吉他、鼓组 |
| 演奏可视化 | ✅ | 按键高亮 + 轨迹效果 + 多音符显示 |
| 基准音调节 | ✅ | 可自定义基准音（C3-C4） |
| 音量控制 | ✅ | 可调节主音量 |
| 移动端适配 | ✅ | QWERTY + 钢琴键盘双模式 |
| 粒子特效 | ✅ | ParticleCanvas 粒子视觉反馈 |

### 🐛 遗留 Bug（已关闭）

| 问题 | 状态 | 说明 |
|-----|------|------|
| 移动端音色不加载 | ✅ 已关闭 | GitHub 国内访问受限，无解；暂不处理 |
| 粒子特效效果 | ✅ 已关闭 | 与 colorpiano 风格不同，暂不处理 |

### 💭 反思

**做得好的**
- 文档先行，里程碑文档清晰
- 技术选型合理（smplr + React + Mantine）
- 响应式布局及时补救

**需要改进**
- 移动端测试不足，交互问题后期发现
- 键盘布局改动反复（两列布局 revert）
- 部署规则沟通成本

**教训**
- 涉及交互限制（AudioContext）应提前查文档
- 移动端适配应在早期覆盖，而非后期修复
